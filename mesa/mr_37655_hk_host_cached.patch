From 05b927ac7e35db6ea8e661fda5415b1b0230a3c6 Mon Sep 17 00:00:00 2001
From: TellowKrinkle <TellowKrinkle@gmail.com>
Date: Sun, 28 Sep 2025 19:50:25 +0200
Subject: [PATCH 1/2] hk: Enable caching on memory marked with HOST_CACHED_BIT

cc: mesa-stable

Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/37655>
---
 src/asahi/vulkan/hk_device_memory.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/src/asahi/vulkan/hk_device_memory.c b/src/asahi/vulkan/hk_device_memory.c
index 81566327e17b2..b91e2001999d4 100644
--- a/src/asahi/vulkan/hk_device_memory.c
+++ b/src/asahi/vulkan/hk_device_memory.c
@@ -211,6 +211,8 @@ hk_AllocateMemory(VkDevice device, const VkMemoryAllocateInfo *pAllocateInfo,
       enum agx_bo_flags flags = 0;
       if (handle_types)
          flags |= AGX_BO_SHAREABLE;
+      if (type->propertyFlags & VK_MEMORY_PROPERTY_HOST_CACHED_BIT)
+         flags |= AGX_BO_WRITEBACK;
 
       mem->bo = agx_bo_create(&dev->dev, aligned_size, 0, flags, "App memory");
       if (!mem->bo) {
-- 
GitLab


From e14adc5cb27aca4e68bcc201c8549b27d7c8c94b Mon Sep 17 00:00:00 2001
From: TellowKrinkle <TellowKrinkle@gmail.com>
Date: Sun, 28 Sep 2025 19:51:20 +0200
Subject: [PATCH 2/2] hk: Add non-cached memory type

Part-of: <https://gitlab.freedesktop.org/mesa/mesa/-/merge_requests/37655>
---
 src/asahi/vulkan/hk_physical_device.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/src/asahi/vulkan/hk_physical_device.c b/src/asahi/vulkan/hk_physical_device.c
index 174de4398b049..a31b6fde5451e 100644
--- a/src/asahi/vulkan/hk_physical_device.c
+++ b/src/asahi/vulkan/hk_physical_device.c
@@ -1261,6 +1261,13 @@ hk_create_drm_physical_device(struct vk_instance *_instance,
       .heapIndex = sysmem_heap_idx,
    };
 
+   pdev->mem_types[pdev->mem_type_count++] = (VkMemoryType){
+      .propertyFlags = VK_MEMORY_PROPERTY_HOST_VISIBLE_BIT |
+                       VK_MEMORY_PROPERTY_HOST_COHERENT_BIT |
+                       VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT,
+      .heapIndex = sysmem_heap_idx,
+   };
+
    assert(pdev->mem_heap_count <= ARRAY_SIZE(pdev->mem_heaps));
    assert(pdev->mem_type_count <= ARRAY_SIZE(pdev->mem_types));
 
-- 
GitLab

