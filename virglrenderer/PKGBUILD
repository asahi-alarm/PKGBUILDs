# Maintainer: Jos Dehaes <jos.dehaes@gmail.com>
# Maintainer: Matthias Kurz <m.kurz@irregular.at>

pkgname=virglrenderer
_commit=b997bc18fafdcb8e563b7b07b54412ea61e12082
_shortcommit=${_commit:0:7}
pkgver=1.1.1^git20250806.${_shortcommit}
pkgrel=1
epoch=1
pkgdesc='A virtual 3D GPU library, that allows the guest operating system to use the host GPU to accelerate 3D rendering'
arch=('x86_64' 'aarch64')
url="https://virgil3d.github.io/"
license=('MIT')
depends=(libepoxy mesa libva vulkan-icd-loader)
makedepends=('git' 'meson' 'ninja' 'python-yaml') # Tools for building from Git
conflicts=('virglrenderer-asahi')
replaces=('virglrenderer-asahi')

source=("${pkgname}-${_commit}.tar.bz2::https://gitlab.freedesktop.org/virgl/virglrenderer/-/archive/${_commit}/virglrenderer-${_commit}.tar.bz2")
sha256sums=('682aeabab96848fa8e3cc06dfa2c76875f937be7a3f07e689f18a86222738ccc')

prepare() {
  cd "${srcdir}/${pkgname}-${_commit}"
  # If there are submodules (unlikely here), uncomment:
  # git submodule update --init --recursive
}

build() {
  cd "${srcdir}/${pkgname}-${_commit}"
  mkdir -p build
  meson setup build \
    --prefix=/usr \
    --libexecdir=lib/$pkgname \
    -Dvideo=true \
    -Ddrm-renderers=asahi \
    -Dvenus=true

  meson compile -C build
}

package() {
  cd "${srcdir}/${pkgname}-${_commit}"
  DESTDIR="${pkgdir}" meson install -C build
  install -D -m644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"
}
