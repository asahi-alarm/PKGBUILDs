# Maintainer: Jos Dehaes <jos.dehaes@gmail.com>
# Maintainer: Matthias Kurz <m.kurz@irregular.at>

pkgname=virglrenderer
pkgver=1.2.0
pkgrel=1
epoch=1
pkgdesc='A virtual 3D GPU library, that allows the guest operating system to use the host GPU to accelerate 3D rendering'
arch=('x86_64' 'aarch64')
url="https://virgil3d.github.io/"
license=('MIT')
depends=(libepoxy mesa libva vulkan-icd-loader)
makedepends=('git' 'meson' 'ninja' 'python-yaml') # Tools for building from Git
conflicts=('virglrenderer-asahi')
replaces=('virglrenderer-asahi')

source=("${pkgname}-${pkgver}.tar.bz2::https://gitlab.freedesktop.org/virgl/virglrenderer/-/archive/${pkgver}/virglrenderer-${pkgver}.tar.bz2")
sha256sums=('f4f52db11297b52b35c8c2d5bf5e21b7997b52f8bfad99ea2b1c155997cff4ad')

prepare() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  # If there are submodules (unlikely here), uncomment:
  # git submodule update --init --recursive
}

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  mkdir -p build
  meson setup build \
    --prefix=/usr \
    --libexecdir=lib/$pkgname \
    -Dvideo=true \
    -Ddrm-renderers=asahi,msm \
    -Dvenus=true

  meson compile -C build
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  DESTDIR="${pkgdir}" meson install -C build
  install -D -m644 COPYING "$pkgdir/usr/share/licenses/$pkgname/COPYING"
}
