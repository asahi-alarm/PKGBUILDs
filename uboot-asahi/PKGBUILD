# Maintainer: Jos Dehaes <jos.dehaes@gmail.com>
# Maintainer: Matthias Kurz <m.kurz@irregular.at>

pkgname=uboot-asahi
_ver=2025.10
_asahirel=1

pkgver=${_ver}.asahi${_asahirel}
pkgrel=1
pkgdesc='U-Boot for Apple Silicon Macs'
_commit_id=asahi-v${_ver}-${_asahirel}
_srcname=u-boot-${_commit_id}
arch=('aarch64')
url='http://asahilinux.org'
license=('MIT' 'GPL2')
makedepends=( bc imagemagick )
source=(
  "u-boot-${_commit_id}.tar.gz::https://github.com/AsahiLinux/u-boot/archive/${_commit_id}.tar.gz"
  'disable-VBE-by-default.patch'
  'enable-bootmenu-by-default.patch'
  'uefi-distro-load-FDT-from-any-partition-on-boot-device.patch'
  'uefi-Add-all-options-for-EFI-System-Partitions.patch'
  '0001-Revert-efi_loader-install-device-tree-on-configurati.patch'
  'uefi-initial-find_fdt_location-for-finding-the-DT-on-disk.patch'
  'uefi-enable-SetVariableRT-with-volotile-storage.patch'
  'uefi-enable-https-boot-by-default.patch'
  'USB-PD-TCPM-improvements.patch'
  'rockchip-Enable-preboot-start-for-pci-usb.patch'
  'Initial-MNT-Reform2-support.patch'
  'p3450-fix-board.patch'
  'JetsonTX2-Fix-upstream-device-tree-naming.patch'
  'Allwinner-fix-booting-on-a-number-of-devices.patch'
  'Improve-RaspBerry-Pi-5-support-part1-Fixes.patch'
  'openssl-no-engine.patch'
)
sha256sums=('8c763e0f8912a4e991da73100f9d9d9c1c723a733e4004d9435b0a1681c0560a'
            '501fe48668729525520253228945dc728c9bf2d9f0a41744711ca51a060e9c7b'
            '9d1796f8c1492bb50c13f865b4bc6854f825218836e55ce36e348c4dd77caa74'
            '0f980cf61fab268a6aa2440408548d3874aee1de6eb6e3be291690b1d2eb6904'
            '16904a97fc62bba84bde3a18885156b8c202c366bb6a0e0dd54414c016695876'
            '3c109751322200c95218af04ae81a8b8d1143e0fc85c00493a49029e23102a52'
            'f4f37d4ee8840d035ee6ec6a215e740ef236f13213840ead7a6ce55d0651d6ef'
            'c77853d6c25b11b7ffca8d522e03bf8e1305b8637e27c5074ddeef3a22956bbf'
            '404e5111fba40d234f3172e9d024e8e2b2d5d98406aba592b59ebde43fd0f19f'
            '3dd92f1f51fccfbb1ceae701db68a6ae42916ddc2d4645b3a61486b582721a54'
            'c5f1e19161fdd6e8893b6b1a989eab2d1ba2c345c602b447661d027f886d3d56'
            '217b4a8bb045dc2b1319b5248f99afa16bd17f705e0ce3f003091bb218b326d8'
            '9cf3e7694efd82a0fe6725069b12971a4f32d05e4e9862089cbf1779a7d2df7c'
            '77aff72eb2319d3a80e0ccb63bdfb7d1c503c91fb515acc9525d029b25bb1fdc'
            '0bb2e47484d67935f1ef6107433f51747211a143f549b4ba60081a143026fb22'
            '049940cba61d947fc8f6430a5dbf732a099eb6643f58ccecef0731502356286a'
            '3ede37fd744d60d934a7d5186f0bcd13d67ae9a48d973283356bbe7451d337e4')
b2sums=('d42dc640483f3392efaacf3c29cecb1dadbc539524ae482918ab963dda2c7845bb83d7f8bc44a147503866169afd75c264d79f9fc03c3c1f6931a33bc1275a44'
        '8fcba2b6c098125fc6ddee33b634af35bc6a8ae93c4f9cf3698f3f4455f97e22c6d8630c60776710770128f73377d2a9364c70dab6705707c1f3223e7493ce14'
        '79709278b47f8e21e7376031c3dc472070c5b18b29b48eefc9d3a4d97b69104eae9325ed8fff8e7a509a89727c8335c90345807d72afacee069557e46ff5724c'
        '34bebf1fe1126ff03d31abaca5908036268c231a77beebbe683cca3f80a4add12faf0e0ed27975c5fa1ba2a9994395ad0ee8115e9ecb8d3686975602981bf136'
        'b4ede5b7eced7a3459a169f5d49712647cc7cc3aec9935eea6283522245b6c3cc300ed8fb81be0dd942dddefd3bda49530270ec3f9215d2f9a52efa4c3bc5ba9'
        '0ad3ba527562ecda5b1bbe03ffe0693c877985e3044f3365559c879273fdabbb351c674801fbd17a00779b632fc7a48a84dd6b82a38063ac32fb9cea3efb0827'
        '3446af0dc21f9b294794fbf747b8fa8693506d07a8556623bf28adee0b61e03666dd0c64ea142c4571f2ab81b1974a11134fe17dbc258ceab3612b5045649be7'
        '2a61869cdefd59715d8d860e4860d52a6e3fc33f2b8511c5d6f78c68f7dda00195b29bf9a213668a3eedf445958b923bc7051fc38c6965c3b7803266cae16bb2'
        '5c2609eca8cf3631407752f5bcf5dc077447cc0ea8e31a523a29cba1d1a51dfc1682248a4bf7be0667bd747784783c307092c635995cdfaf488337f9313b85ec'
        '6cf5a8fe4631a60247df626e4fea6efadad4d2ccf62dd30330fa0a98546deee17a394d8b7fef8fa5446311f01c05a303f88818a4ffa6b49810c5ec06fae1aa46'
        'ffd266fac8409bd6528cbbb7803c689a98427015d673558cdafb4abf557497f43e86de26672d2fe0c9aae60a9955cd41d92fcbc31820f434555e35b90fc4af42'
        '373e94e5eb8ad557ee29e0d79b3825c72a102209cd7ca654f1f4fab562737debb9678ba8c3846d15765ca4a41264ad55e9c9545272c7ff002cc69a3595b5104f'
        '828275a8cdda2df5ef0698f12871cb24bcd758373d43907120495eb094fc1ddf6e25414384a52c56f2c5629a2b1702571fd368c02f1ae67ae25a2d59c0a850f3'
        '08bd592cc066e2dc9216228384a6c1d650860479ae3fa8fbe4ac0b6cf8596a25e5c11bbb52a19e3c35a4de279b4746e30e376ba4273f0121c2889d7ebc6a938d'
        'b018ec8f631f9ec15bb054f85b526fb4b4bb04b954ef9a038a6c9fd1230bbbb5af8d82b04d30c220820cb5f35c77ad1e3763835244da93486f3261fe12d1f06a'
        '75b6b4aca2e4ee036b3dce5b1eba718e5f4d8aae64625a67990190e237bb22c6c4937eccafacff2b23763eedfbb631fdfbd31ddd4480cd315678140281185864'
        '81a2b3b089267d636cc60f23a0f4f82ba36ecb5e210c84c7cbdf2af1b764e0c40ba3b22fec26bc7c8eab052cfa30893aac4b3c76b9a56d763841b8f7821820de')

prepare() {
  cd "${srcdir}/$_srcname"

  cat ../disable-VBE-by-default.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../enable-bootmenu-by-default.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../uefi-distro-load-FDT-from-any-partition-on-boot-device.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../uefi-Add-all-options-for-EFI-System-Partitions.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../0001-Revert-efi_loader-install-device-tree-on-configurati.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../uefi-initial-find_fdt_location-for-finding-the-DT-on-disk.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../uefi-enable-SetVariableRT-with-volotile-storage.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../uefi-enable-https-boot-by-default.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../USB-PD-TCPM-improvements.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../rockchip-Enable-preboot-start-for-pci-usb.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../Initial-MNT-Reform2-support.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../p3450-fix-board.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../JetsonTX2-Fix-upstream-device-tree-naming.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../Allwinner-fix-booting-on-a-number-of-devices.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../Improve-RaspBerry-Pi-5-support-part1-Fixes.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f
  cat ../openssl-no-engine.patch | patch -p1 -s --fuzz=0 --no-backup-if-mismatch -f

  make apple_m1_defconfig
}

build() {
  cd "${srcdir}/$_srcname"
  make
}

package() {
  cd "${srcdir}"

  tgtdir="$pkgdir/usr/lib/asahi-boot"

  install -Dt "$tgtdir" -m644 "$_srcname/u-boot-nodtb.bin"
  install -Dt "$tgtdir/dtb" -m644 "$_srcname/arch/arm/dts/"t[86]*.dtb
}
